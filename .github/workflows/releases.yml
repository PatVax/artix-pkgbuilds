name: Release
run-name: Release ${{ github.ref_name }}

on:
  push:
    tags: 
      - '*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    container: 
      image: artixlinux/artixlinux:base-devel
      options: --privileged
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      GPG_SECRET: ${{ secrets.GPG_SECRET }}
      BUILD_USER: "builder"
    permissions:
      contents: write

    steps:
      - name: Update build system
        run: pacman -Syu --noconfirm

      - name: Install general build dependencies
        run: pacman -S git artools-pkg --noconfirm

      - name: Create build user
        run: useradd -M $BUILD_USER

      - name: "Allow the \"$BUILD_USER\" user to run commands as root"
        run: "echo \"$BUILD_USER ALL=(ALL:ALL) NOPASSWD: ALL\" >> /etc/sudoers"
    
      - name: Checkout
        uses: actions/checkout@v4

      - name: "Add permissions to current directory for the \"$BUILD_USER\" user"
        run: chown -R $BUILD_USER:$BUILD_USER .

      - name: Build the package
        run: sudo -u $BUILD_USER makepkg -s --noconfirm

      - name: Import GPG key from secrets with passphrase
        run: echo "$GPG_SECRET" | gpg --batch --yes --import
      
      - name: Sign the package
        run: echo "$GPG_PASSPHRASE" | gpg --batch --yes --detach-sign --passphrase-fd 0 --pinentry-mode=loopback -u 'PatVax-artx-pkgbuilds <patvax0x0@gmail.com>' *.pkg.tar.zst

      - name: Install github cli
        run: pacman -S github-cli --noconfirm

      - name: Create the release
        run: sudo -E -u $BUILD_USER gh release create --generate-notes --verify-tag -t "Release ${{ github.ref_name }}" ${{ github.ref_name }} *.pkg.tar.zst*